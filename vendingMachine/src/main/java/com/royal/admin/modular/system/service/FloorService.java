package com.royal.admin.modular.system.service;

import cn.stylefeng.roses.kernel.model.exception.ServiceException;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.conditions.update.UpdateWrapper;
import com.baomidou.mybatisplus.extension.api.R;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.royal.admin.core.common.constant.state.ZdyMachines;
import com.royal.admin.core.common.exception.BizExceptionEnum;
import com.royal.admin.core.util.HttpUtils;
import com.royal.admin.core.util.JSONUtils;
import com.royal.admin.core.util.ZdySignUtil;
import com.royal.admin.modular.system.entity.Commodity;
import com.royal.admin.modular.system.entity.Floor;
import com.royal.admin.modular.system.entity.Replenishment;
import com.royal.admin.modular.system.factory.FloorFactory;
import com.royal.admin.modular.system.mapper.FloorMapper;
import com.royal.admin.modular.system.model.zdy.ZdyFloor;
import com.royal.admin.modular.system.model.zdy.ZdyReturn;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * <p>
 * 设备表 服务实现类
 * </p>
 *
 * @author stylefeng
 * @since 2018-12-07
 */
@Service
public class FloorService extends ServiceImpl<FloorMapper, Floor> {
    @Autowired
    private CommodityService commodityService;
    @Autowired
    private ReplenishmentService replenishmentService;

    private static final Logger log = LoggerFactory.getLogger(FloorService.class);

    public void syncFrool(String machineNo) {
        HashMap<String, String> param = new HashMap<>();
        param.put("machine_no", machineNo);
        String sign = ZdySignUtil.getSign(param);
        param.put("sign", sign);
        HashMap<String, String> headerMap = new HashMap<>();
        headerMap.put("appid", ZdyMachines.APPID.getMessage());
        String s = HttpUtils.doGet(ZdyMachines.FLOOR_LIST_URL.getMessage(), param, headerMap);
//        String s="{\"code\":1,\"msg\":\"ok\",\"data\":[{\"code\":\"000\",\"status\":1,\"display_code\":\"000\",\"price\":\"4.00\",\"is_rent\":0,\"stock\":10,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\\u53ef\\u53e3\\u53ef\\u4e50\",\"goods_image\":\"http:\\/\\/qiniu.zhongdacloud.com\\/uploads\\/shop_51\\/20191027\\/5db556cb4edb25KF7pUAwK99Oe.png\",\"goods_desc\":\"\",\"is_goods\":\"1\"},{\"code\":\"001\",\"status\":2,\"display_code\":\"001\",\"price\":\"30.00\",\"is_rent\":0,\"stock\":5,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\\u85af\\u7247\",\"goods_image\":\"http:\\/\\/qiniu.zhongdacloud.com\\/uploads\\/shop_51\\/20191027\\/5db54eddc219eHxNVl4anuNpVk.png\",\"goods_desc\":\"<p>\\u6d4b\\u8bd5<\\/p>\",\"is_goods\":\"1\"},{\"code\":\"002\",\"status\":0,\"display_code\":\"002\",\"price\":\"5.00\",\"is_rent\":0,\"stock\":4,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\\u53ef\\u53e3\\u53ef\\u4e50\",\"goods_image\":\"http:\\/\\/qiniu.zhongdacloud.com\\/uploads\\/shop_51\\/20191027\\/5db556cb4edb25KF7pUAwK99Oe.png\",\"goods_desc\":\"\",\"is_goods\":\"1\"},{\"code\":\"003\",\"status\":1,\"display_code\":\"003\",\"price\":\"5.00\",\"is_rent\":0,\"stock\":3,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\\u53ef\\u53e3\\u53ef\\u4e50\",\"goods_image\":\"http:\\/\\/qiniu.zhongdacloud.com\\/uploads\\/shop_51\\/20191027\\/5db556cb4edb25KF7pUAwK99Oe.png\",\"goods_desc\":\"\",\"is_goods\":\"1\"},{\"code\":\"004\",\"status\":1,\"display_code\":\"004\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"005\",\"status\":1,\"display_code\":\"005\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"006\",\"status\":1,\"display_code\":\"006\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"007\",\"status\":1,\"display_code\":\"007\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"008\",\"status\":1,\"display_code\":\"008\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"009\",\"status\":1,\"display_code\":\"009\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"100\",\"status\":1,\"display_code\":\"100\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"101\",\"status\":1,\"display_code\":\"101\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"102\",\"status\":1,\"display_code\":\"102\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"103\",\"status\":1,\"display_code\":\"103\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"104\",\"status\":1,\"display_code\":\"104\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"105\",\"status\":1,\"display_code\":\"105\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"106\",\"status\":1,\"display_code\":\"106\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"107\",\"status\":1,\"display_code\":\"107\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"108\",\"status\":1,\"display_code\":\"108\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"109\",\"status\":1,\"display_code\":\"109\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"200\",\"status\":1,\"display_code\":\"200\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"201\",\"status\":1,\"display_code\":\"201\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"202\",\"status\":1,\"display_code\":\"202\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"203\",\"status\":1,\"display_code\":\"203\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"204\",\"status\":1,\"display_code\":\"204\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"205\",\"status\":1,\"display_code\":\"205\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"206\",\"status\":1,\"display_code\":\"206\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"207\",\"status\":1,\"display_code\":\"207\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"208\",\"status\":1,\"display_code\":\"208\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"209\",\"status\":1,\"display_code\":\"209\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"300\",\"status\":1,\"display_code\":\"300\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"301\",\"status\":1,\"display_code\":\"301\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"302\",\"status\":1,\"display_code\":\"302\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"303\",\"status\":1,\"display_code\":\"303\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"304\",\"status\":1,\"display_code\":\"304\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"305\",\"status\":1,\"display_code\":\"305\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"306\",\"status\":1,\"display_code\":\"306\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"307\",\"status\":1,\"display_code\":\"307\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"308\",\"status\":1,\"display_code\":\"308\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"309\",\"status\":1,\"display_code\":\"309\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"400\",\"status\":1,\"display_code\":\"400\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"401\",\"status\":1,\"display_code\":\"401\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"402\",\"status\":1,\"display_code\":\"402\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"403\",\"status\":1,\"display_code\":\"403\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"404\",\"status\":1,\"display_code\":\"404\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"405\",\"status\":1,\"display_code\":\"405\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"406\",\"status\":1,\"display_code\":\"406\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"407\",\"status\":1,\"display_code\":\"407\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"408\",\"status\":1,\"display_code\":\"408\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"409\",\"status\":1,\"display_code\":\"409\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"500\",\"status\":1,\"display_code\":\"500\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"501\",\"status\":1,\"display_code\":\"501\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"502\",\"status\":1,\"display_code\":\"502\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"503\",\"status\":1,\"display_code\":\"503\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"504\",\"status\":1,\"display_code\":\"504\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"505\",\"status\":1,\"display_code\":\"505\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"506\",\"status\":1,\"display_code\":\"506\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"507\",\"status\":1,\"display_code\":\"507\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"508\",\"status\":1,\"display_code\":\"508\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"509\",\"status\":1,\"display_code\":\"509\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"600\",\"status\":1,\"display_code\":\"600\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"601\",\"status\":1,\"display_code\":\"601\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"602\",\"status\":1,\"display_code\":\"602\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"603\",\"status\":1,\"display_code\":\"603\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"604\",\"status\":1,\"display_code\":\"604\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"605\",\"status\":1,\"display_code\":\"605\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"606\",\"status\":1,\"display_code\":\"606\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"607\",\"status\":1,\"display_code\":\"607\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"608\",\"status\":1,\"display_code\":\"608\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"609\",\"status\":1,\"display_code\":\"609\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"700\",\"status\":1,\"display_code\":\"700\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"701\",\"status\":1,\"display_code\":\"701\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"702\",\"status\":1,\"display_code\":\"702\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"703\",\"status\":1,\"display_code\":\"703\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"704\",\"status\":1,\"display_code\":\"704\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"705\",\"status\":1,\"display_code\":\"705\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"706\",\"status\":1,\"display_code\":\"706\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"707\",\"status\":1,\"display_code\":\"707\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"708\",\"status\":1,\"display_code\":\"708\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"709\",\"status\":1,\"display_code\":\"709\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"800\",\"status\":1,\"display_code\":\"800\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"801\",\"status\":1,\"display_code\":\"801\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"802\",\"status\":1,\"display_code\":\"802\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"803\",\"status\":1,\"display_code\":\"803\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"804\",\"status\":1,\"display_code\":\"804\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"805\",\"status\":1,\"display_code\":\"805\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"806\",\"status\":1,\"display_code\":\"806\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"807\",\"status\":1,\"display_code\":\"807\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"808\",\"status\":1,\"display_code\":\"808\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"809\",\"status\":1,\"display_code\":\"809\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"900\",\"status\":1,\"display_code\":\"900\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"901\",\"status\":1,\"display_code\":\"901\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"902\",\"status\":1,\"display_code\":\"902\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"903\",\"status\":1,\"display_code\":\"903\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"904\",\"status\":1,\"display_code\":\"904\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"905\",\"status\":1,\"display_code\":\"905\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"906\",\"status\":1,\"display_code\":\"906\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"907\",\"status\":1,\"display_code\":\"907\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"908\",\"status\":1,\"display_code\":\"908\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"},{\"code\":\"909\",\"status\":1,\"display_code\":\"909\",\"price\":\"0.00\",\"is_rent\":0,\"stock\":0,\"sn\":\"\",\"rfid_status\":0,\"unit\":\"\",\"deposit\":0,\"goods_name\":\"\",\"goods_image\":\"\",\"goods_desc\":\"\",\"is_goods\":\"0\"}]}";
        ZdyReturn z = JSONUtils.toBean(s, ZdyReturn.class, "data", ZdyFloor.class);
        System.out.println(z.toString());
        List<Floor> floorList = getFloorList(machineNo);
        List<ZdyFloor> list = (List<ZdyFloor>) z.getData();
        if (floorList == null || floorList.size() == 0) {
            List<Floor> newFloorList = FloorFactory.foundFloor(list, machineNo);
            if (newFloorList != null) {
                this.saveBatch(newFloorList);
            }
        } else {
            if (list != null) {
                UpdateWrapper<Floor> floorUpdateWrapper = new UpdateWrapper<>();
                floorUpdateWrapper.eq("machine_id", machineNo);
                Floor floor = new Floor();
                floor.setFloorStatus(0);
                this.baseMapper.update(floor, floorUpdateWrapper);
                this.baseMapper.batchUpdateStatus(list, machineNo);
            }

        }
    }

    public List<Map<String, Object>> selectFloorInfo(String machinesId) {
        return this.baseMapper.selectFloorInfo(machinesId);
    }

    public List<Floor> getFloorList(String machineNo) {
        QueryWrapper<Floor> floorQueryWrapper = new QueryWrapper<>();
        floorQueryWrapper.eq("machine_id", machineNo);
        return this.baseMapper.selectList(floorQueryWrapper);
    }

    /**
     * 绑定商品
     *
     * @param floorId
     * @param commodityId
     */
    public void setGoods(Integer floorId, String commodityId) {
        Commodity commodity = commodityService.getById(commodityId);
        Floor floor = this.baseMapper.selectById(floorId);
        if (commodity == null || floor == null) {
            throw new ServiceException(BizExceptionEnum.REQUEST_NULL);
        }
        floor.setGoodsId(commodityId);
        floor.setGrade(commodity.getGrade());
        this.baseMapper.updateById(floor);
    }

    public void updateGradeOrStock(Integer floorId, Integer grade, Integer stock) {
        Floor floor = this.baseMapper.selectById(floorId);
        if (floor.getStock() != stock) {
            Replenishment replenishment = new Replenishment();
            replenishment.setFloorId(floor.getFloorId());
            replenishment.setGoodsId(floor.getGoodsId());
            replenishment.setMachinesId(floor.getMachineId());
            if (floor.getStock() < stock) {
                replenishment.setNumber(stock-floor.getStock());
                replenishment.setStatus("REOLENISH");
            }else{
                replenishment.setNumber(floor.getStock()-stock);
                replenishment.setStatus("WITHDRAW");
            }
            replenishmentService.save(replenishment);
        }
        floor.setGrade(grade);
        floor.setStock(stock);
        System.out.println(floor.toString());
        this.baseMapper.updateById(floor);
    }
}
